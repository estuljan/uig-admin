name: Deploy

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.10
        env:
          DATABASE_URI: ${{ secrets.DATABASE_URI }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_PUBLIC_SERVER_URL: ${{ secrets.PAYLOAD_PUBLIC_SERVER_URL }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.SSH_KEY }}
          envs: DATABASE_URI,PAYLOAD_SECRET,PAYLOAD_PUBLIC_SERVER_URL
          script: |
            set -euo pipefail

            IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main"
            CONTAINER_NAME="uig-admin"
            ROLLBACK_CONTAINER=""

            rollback() {
              echo "新容器启动失败！正在回滚..."
              TARGET="${ROLLBACK_CONTAINER:-}"
              if [ -z "${TARGET:-}" ]; then
                TARGET=$(docker ps -a --filter "name=${CONTAINER_NAME}-old" --format '{{.Names}}' | head -n 1 || true)
              fi
              if [ -n "${TARGET:-}" ]; then
                docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true
                docker rename "${TARGET}" "${CONTAINER_NAME}"
                docker start "${CONTAINER_NAME}"
                echo "已回滚到旧容器 ${TARGET}。"
              else
                echo "没有找到可用的旧容器可供回滚。"
              fi
              exit 1
            }

            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u "${{ github.actor }}" --password-stdin

            docker pull "${IMAGE_TAG}"

            if docker ps -a --format '{{.Names}}' | grep -Eq "^${CONTAINER_NAME}$"; then
              docker stop "${CONTAINER_NAME}" || true
              ROLLBACK_CONTAINER="${CONTAINER_NAME}-old-$(date +%s)"
              docker rename "${CONTAINER_NAME}" "${ROLLBACK_CONTAINER}"
            fi

            if ! docker run -d \
              -p 5511:3000 \
              --name "${CONTAINER_NAME}" \
              --restart unless-stopped \
              -e DATABASE_URI="${DATABASE_URI}" \
              -e PAYLOAD_SECRET="${PAYLOAD_SECRET}" \
              -e PAYLOAD_PUBLIC_SERVER_URL="${PAYLOAD_PUBLIC_SERVER_URL}" \
              -e PORT="3000" \
              "${IMAGE_TAG}"; then
              rollback
            fi

            sleep 10

            if docker ps --format '{{.Names}}' | grep -Eq "^${CONTAINER_NAME}$"; then
              echo "新 Payload 容器 ${CONTAINER_NAME} 启动成功！"
              docker ps -a --filter "name=${CONTAINER_NAME}-old" --format '{{.ID}}' | xargs -r docker rm -f
            else
              rollback
            fi
